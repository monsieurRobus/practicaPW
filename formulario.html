<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Inmo Gru3p</title>
	<link rel="stylesheet" href="css/estilos.css">
</head>
<body>

     <script>
//El método setItem() de LocalStorage almacena el par clave -calor o actualiza el valor si la clave ya existe.	
//Para guardar los usuarios vamos a usar su dni (dni.value) como clave y en el valor meteremos los valores de todos los campos del formulario  en un String. Separaremos el valor de los campos con #

		function guardar(){ 
				 
		var dni = document.getElementById("dni");// variable donde se guarda el dni del usuario
		localStorage.setItem(dni.value, dni.value);  // guardar en LocalStoprage el valor del dni como clave y su valor como valor
		
		localStorage.setItem(dni.value, nombre.value+"#"+apellidos.value+"#"+fecha.value+"#"+calle.value+"#"+poblacion.value+"#"+pais.value+"#"+telefono.value+"#"+mail.value+"#"+usuario.value+"#"+contrasena.value+"#"+repetir.value); 
		 
            console.log(localStorage);
		  }
		
		
//La propiedad  LocalStorage permite acceder al objeto Storage donde comprobaremos uno por uno todos los valores almacenados para ver si coinciden con los del nuevo usuario. 	
		

	
		 
		 
		  function valida_envio() { 
		 
		
		 
		 		// variable que tendrá valor verdadero cuando el campo esté ok, pero retornaremos false cuando no cumpla la validación 	
				continuar= true;
		  		var aviso = document.getElementById("aviso");// guardamos en la variable "aviso" el id que corresponde a un párrafo en HTML
				aviso.innerHTML = "" //utilizamos innerHTML para escribir dentro del párrafo con id "aviso"
		
			
// campo nombre obligatorio			
			if (document.formulario.nombre.value==""){
						
           		aviso.innerHTML = "Debes escribir tu nombre <br/>"; 
				return false;
			}	
// campo apellido obligatorio			
			if (document.formulario.apellidos.value==""){
						
           		aviso.innerHTML = "Debes escribir tus apellidos <br/>"; 
				return false;
			}					
				
// validar dni. Tiene que comprobar que la letra que equivale al resto de sumar los dígitos del DNI entre 23 en una tabla coincide con la letra del DNI 
		 	var dni = document.formulario.dni.value;
			if(/^\d{8}[a-zA-Z]$/.test (dni) == true){//valida mediante expresión regular que el valor tenga 8 dígitos primero y un caracter minúscula o mayúscula y si es verdad
				 numero = dni.substr(0,dni.length-1); // separa la variable con el número por un lado
				 letra = dni.substr(dni.length-1,1); // variable con la letra
				 numero = numero % 23;//se divide el número entre 23 porque así se valida el DNI
				 tablaMinisterio='TRWAGMYFPDXBNJZSQVHLCKET';
				 tablaMinisterio=tablaMinisterio.substring(numero,numero+1);// con el resto del módulo buscamos el caracter en la tabla
				if ((tablaMinisterio!=letra.toUpperCase() )|| (dni == "")) { // si el caracter con la letra del DNI no coinciden o el campo está vacía
				   //alert('El DNI es incorrecto');
				 
           			aviso.innerHTML = "Escribe un número de DNI válido.<br/>";
					return false;
				}
			 }else{
				//alert('El DNI es incorrecto');// si el dni introducido no para la expresión regular establecida en la primera condición
				aviso.innerHTML = "Escribe un número de DNI válido.<br/>";  
				return false;
			 }// cierre validación DNI
		 


		 
		 
//Valida fecha de nacimiento
				var fecha= document.formulario.fecha.value; 
				var vector= fecha.split("/"); //  split("")separa la fecha por los lugares donde se encuentra / 
				diaNacimiento= vector[0]; 
				mesNacimiento= vector[1];
				anoNacimiento= vector[2];
				//document.write(	diaNacimiento + " " +	mesNacimiento + " " + anoNacimiento);
				var hoy = new Date(); // recuperamos la fecha de hoy
				var dia = hoy.getDate(); //dia contiene el diad e hoy
				var mes = hoy.getMonth() +1 ; //contiene el mes de hoy en un array con índices del 0 al 11, le sumamos 1
				var anyo = hoy.getFullYear();
				//document.write(dia+"/"+ mes +"/"+ anyo);
				if (fecha == ""){
						
           		aviso.innerHTML = "Debes escribir tu fecha de nacimiento <br/>"; 
				return false;
				}	
				else if (anoNacimiento > (anyo-18)){ // condiciones: que haya  nacido antes de el año en que nos encontramos -18
					aviso.innerHTML = "Lo sentimos, tienes que ser mayor de edad.<br/>";
					return false;
					}else if(anoNacimiento < (anyo-18)){
					
						} else if ((anoNacimiento = (anyo-18)) && (mesNacimiento > mes)){ // y siestamos en el mismo año que el mes sea anterior al que nos encontramos
						aviso.innerHTML = "Lo sentimos, tienes que ser mayor de edad.<br/>";
						return false;
							}else if ((anoNacimiento = (anyo-18)) && (mesNacimiento < mes)){
						
								} else if ((anoNacimiento = (anyo-18)) && (mesNacimiento = mes) && (diaNacimiento > dia)){
								aviso.innerHTML = "Lo sentimos, tienes que ser mayor de edad.<br/>";
								 return false;
									}else if ((anoNacimiento = (anyo-18)) && (mesNacimiento = mes) && (diaNacimiento <= dia)){
									
				}// cierre validar fecha nacimiento
								
//campo calle es obligatorio NO puede estar "" (vacío)								
				if (document.formulario.calle.value==""){
						
           		aviso.innerHTML = "Debes escribir tu calle <br/>"; 
				return false;
				}					

//Validar C.P. función que mediante una expresión regular comprueba que el valor del campo es un número para el código postal
				var codigopostal = document.formulario.codigo.value;
        		if ((!/^([0-9])*$/.test(codigopostal)) || (codigopostal == "")){// dígitos entre 0 y 9 que pueden estar más de 1 vez
         		//alert("El valor " + codigopostal + " no es un número");
					aviso.innerHTML = "Comprueba el C.P.<br/>";
					return false;
    			  }// cierre condición validación campo numéricos con id "numero" que son el  CP y teléfono
				
//campo país es obligatorio NO puede estar "" (vacío)								
				if (document.formulario.pais.value==""){
						
           		aviso.innerHTML = "Debes escribir tu país <br/>"; 
				return false;
				}					

				
				
//Validar Tfono: función que mediante una expresión regular comprueba que el valor del campo es un número para teléfono
				var telefono = document.formulario.telefono.value;
        		if ((!/^([0-9])*$/.test(telefono)) || (   telefono == "") ){// dígitos entre 0 y 9 que pueden estar más de 1 vez
         		//alert("El valor " + telefono + " no es un número");
				
           			 aviso.innerHTML = "Comprueba el número de teléfono.<br/>" ;
					return false;
    			  }//cierre condición teléfono numérico

		 
		 
//validar correo electrónico con una expresión regular que verifique que el email está compuesto por: texto+@+texto+.+texto
				var email = document.formulario.mail.value;
        		if ((!/[a-zA-Z0-9_.]+@[a-zA-Z0-9]+\.[a-zA-Z]/.test(email)) || (email="")){// testea la variable email con la expresión regular
         		//alert("El valor " + email + " no es válido");
				
           			 aviso.innerHTML = "Comprueba la dirección de correo electrónico.<br/>" ;
					return false;
    			  }//cierre condición correo electrónico

//campo usuario es obligatorio NO puede estar "" (vacío)								
				if (document.formulario.usuario.value==""){
						
           		aviso.innerHTML = "Debes escribir tu usuario <br/>"; 
				return false;
				}					
	 
		 
		 
		  // función que valida el password según requisitos de la práctica
				var pass= document.formulario.contrasena.value;
			// Expresión regular: de principio a fin que tenga al menos 8 caracteres, que al menos haya una letra 			mayúscula y al menos 1 dígito
				if (!/(?=^.{8,}$)(?=.*[A-Z])(?=.*[0-9])/.test(pass)){ //método test que aplica la búsqueda de la expresión en el valor del formulario pasado a la función
				//alert("Contraseña no válida: comprueba si tiene una letra mayúscula, un dígito y 8 caracteres mínimo");
           		 aviso.innerHTML = "Contraseña no válida: comprueba si tiene una letra mayúscula, un dígito y 8 caracteres mínimo.<br/>";	
				return false;
				}//cierre de la condición para validar contraseña 
		
//FUNCIÓN QUE COMPRUEBA QUE LAS 2 CONTRASEÑAS SON IGUALES
//guardamos en la variable passuno el valor del campo con id contrasena
//guardamos en la variable passdos el valor del campo con id repetir
//y si no son iguale sale una ventana alert indicándolo
	
				passuno=document.formulario.contrasena.value; 
				passdos=document.formulario.repetir.value;
				if (passuno != passdos){
					//alert("Las contraseñas no son iguales");
					aviso.innerHTML = "Las contraseñas no son iguales.<br/>";
					return false;
					}// cierre comparación contraseñas				
						
		
//Para comprobar si el usuario existe en el localStorage, comprobamos que el valor metido en el campo dni no coincida con alguna clave del LocalStorage	
				for (i=0; i< localStorage.length; i++){
						if(document.formulario.dni.value == localStorage.key(i)){
							
							aviso.innerHTML = "El usuario con este DNI ya existe. Prueba con otro<br/>"; 
				
							return false;	
						}//cierre condición si el dni es == alguna clave en LocalStorage
						
						//Para comprobar que el nombre y apellidos o correo electrónico no existen, miro la cadena almacenada en el valor del LocalStorgae, hago split mediante el separador # y consulto los índices 0, 1 y 7 del array generado por el método split. En esos índices se encuentran el nombre, apellidos y correo respectivamente.						
						
						separador="#"; //los valores de los campos se han separado con el símbolo de control #
						//valorUsuario es el valor en LocalSorage de la clave (i) si es que no ha encontrado que el dni ya existe en el almacenamiento
						valorUsuario= localStorage[localStorage.key(i)].split(separador);//valorUsuario riene un array con los valores de los campos. El método split es el que ha separado la cadena valor donde se encontraba el símbolo de control #
							if ( document.formulario.nombre.value.toLowerCase() == valorUsuario[0].toLowerCase() &&  document.formulario.apellidos.value.toLowerCase() == valorUsuario[1].toLowerCase() ){
								
								aviso.innerHTML = "El usuario ya existe. Prueba con otro nombre <br/>"; 
				
							return false;	
							}//cierre condición si nombre, apellidos  está en algún usuario de localstorage
							
							if( document.formulario.mail.value.toLowerCase() == valorUsuario[7].toLowerCase()){
								aviso.innerHTML = "El usuario ya existe. Prueba con otro correo <br/>"; 
				
							return false;			
							} // cierre condicion si el correo ya existe en algún usuario del LocalStorage
					
						
						
						
				}//cierre bucle for

		
		
		
		
		guardar ();
	
		window.location="index.html";
		
 }// cierre de function valida campos
		

		
    </script>

	<header>
		<a href="index.html" id="inmo">INMO GRU3P</a>
		<p>La mejor oferta de vivienda en España</p>
	</header>

	<section id="formulario">

	<p id="titulo">FORMULARIO DE REGISTRO</p>

	<form action="" name="formulario" method="get" >

		<input type="text" id="nombre" name="nombre" placeholder="Nombre" required>
		<input type="text" id="apellidos" name="apellidos" placeholder="Apellidos" required>
        <input type="text" id="dni" name="dni" placeholder="DNI-NIF"   required>
		<input type="text" id="fecha" name="fecha" placeholder="Fecha de nacimiento (dd/mm/aaaa)" required >
		<input type="text" id="calle" name="calle" placeholder="Calle" required>
		<input type="text" id="poblacion" name="poblacion" placeholder="Población" required>
		<input type="text" id="codigo" name="codigo" placeholder="C.P." required >
		<input type="text" id="pais" name="pais" placeholder="Pais">
		<input type="text" id="telefono" name="telefono" placeholder="Teléfono" size="9" required >
		<input type="mail" id="mail" name="mail" placeholder="E-mail" required >
		<input type="text" id="usuario" name="usuario" placeholder="Usuario" required>
		<input type="password" id="contrasena" name="contrasena" placeholder="Contraseña" required >
		<input type="password" id="repetir" name="repetir" placeholder="Repetir Contraseña" required >
		<input type="button" value="Enviar" onclick="valida_envio()">

	</form>

	</section>
<p id="aviso"></p>


</body>
</html>